{% extends 'base.html' %}
{% load static %}

{% block title %}Check Out Tool - Tool Program{% endblock %}

{% block content %}
<div class="d-flex mt-4 mb-3">
    <div class="w-auto me-5">
        <h1 class="mt-2">Check Out Tool</h1>
        <h4>Tool Tracker</h4>
    </div>
    <div class="w-auto ms-5">
        <div class="d-flex align-items-center ms-1">
            <img alt="Check Out Icon" class="img-fluid" width="100" src="{% static 'images/checkOut.png' %}" />
        </div>
    </div>
</div>
<hr />

<div class="row">
    <div class="col-md-4">
        <form method="post">
            {% csrf_token %}
            
            <div class="form-group mb-3">
                <label for="tool_select" class="control-label">Tool No</label>
                <input type="text" id="tool_input" class="form-control" onblur="getWC()" value="TTU " list="Tool_Data" name="tool_lookup" placeholder="Type tool serial number...">
                <input type="hidden" id="tool_id" name="tool_id" value="">
                <datalist id="Tool_Data">
                    {% for tool in tools %}
                        <option value="{{ tool.serial_number }}" data-id="{{ tool.id }}">{{ tool.description }}</option>
                    {% endfor %}
                </datalist>
            </div>

            <div class="form-group mb-3">
                <label for="promise_return_date" class="control-label">Promise Return Date</label>
                <input type="date" id="promise_return_date" name="promise_return_date" class="form-control" />
            </div>
            
            <div class="form-group mb-3">
                <label for="from_wc" class="control-label">WC From</label>
                <input type="text" id="from_wc" class="form-control" readonly="readonly" />
                <input type="hidden" id="from_wc_id" name="from_wc_id" value="">
            </div>
            
            <div class="form-group mb-3">
                <label for="to_wc" class="control-label">WC To</label>
                <input type="text" id="to_wc_input" class="form-control" list="Work_Center" placeholder="Type to search..." name="to_wc_lookup">
                <input type="hidden" id="to_wc_id" name="to_wc_id" value="">
                <datalist id="Work_Center">
                    {% for wc in workcenters %}
                        <option value="{{ wc.name }}" data-id="{{ wc.id }}">
                            {% if wc.description %}{{ wc.description }}{% else %}{{ wc.location }}{% endif %}
                        </option>
                    {% endfor %}
                </datalist>
            </div>
            
            <div class="form-group mb-2">
                <label for="employee" class="control-label">Employee No</label>
                <input type="text" id="employee_input" class="form-control" list="Emp_Data" name="employee_lookup" placeholder="Type employee name...">
                <input type="hidden" id="employee_id" name="employee_id" value="">
                <datalist id="Emp_Data">
                    {% for emp in employees %}
                        <option value="{{ emp.employee_number }}" data-id="{{ emp.id }}">{{ emp.first_name }} {{ emp.last_name }}</option>
                    {% endfor %}
                </datalist>
            </div>

            <div class="form-group">
                <input type="submit" value="Check Out" class="btn btn-primary buttonOrange" />
            </div>
        </form>
    </div>
</div>

<div class="mt-2">
    <a href="{% url 'tooltracker:index' %}">Back to List</a>
</div>

<script>
    var ToolInput = document.getElementById("tool_input");

    // Execute a function when the user presses a key on the keyboard
    ToolInput.addEventListener("keypress", function (event) {
        // If the user presses the "Enter" key on the keyboard
        if (event.key === "Enter") {
            // Cancel the default action, if needed
            event.preventDefault();
            getWC();
        }
    });

    // Set hidden IDs based on datalist selections
    document.getElementById('tool_input').addEventListener('input', function() {
        const value = this.value;
        const option = document.querySelector('#Tool_Data option[value="' + value + '"]');
        if (option) {
            document.getElementById('tool_id').value = option.getAttribute('data-id');
        }
    });

    document.getElementById('to_wc_input').addEventListener('input', function() {
        const value = this.value;
        const option = document.querySelector('#Work_Center option[value="' + value + '"]');
        if (option) {
            document.getElementById('to_wc_id').value = option.getAttribute('data-id');
        }
    });

    document.getElementById('employee_input').addEventListener('input', function() {
        const value = this.value;
        const option = document.querySelector('#Emp_Data option[value="' + value + '"]');
        if (option) {
            document.getElementById('employee_id').value = option.getAttribute('data-id');
        }
    });

    function getWC() {
        // Get the tool value from the input
        var toolValue = $("#tool_input").val();

        // Check if the tool value len is greater than "TTU "
        if (toolValue.length > 5) {
            // run helper function in controller to auto enter WC based on tool
            $.ajax({
                type: "POST",
                data: {
                    Tool: toolValue,
                    csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                },
                url: '{% url "tooltracker:get_wc" %}',
            }).done(function (result) {
                $("#from_wc").val(result.wc);
                
                // Set the hidden from_wc_id if we can find it
                const option = document.querySelector('#Work_Center option[value="' + result.wc + '"]');
                if (option) {
                    document.getElementById('from_wc_id').value = option.getAttribute('data-id');
                }
            });
        }
        else {
            //alert("Tool too short");
        }
    }
</script>
{% endblock %}